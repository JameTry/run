<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8"/>
    <style>
        #con {
            width: 500px;
            margin: 0 auto;
        }

        #list {
            width: 200px;
            position: fixed;
            left: 20px;
            padding-right: 20px;
            overflow: scroll;
            height: 100vh;
        }

        #list p.active {
            background: #247cfa;
            color: white;
            padding: 2px;
            font-size: 18px;
            font-weight: 600;
        }

        #bottom {
            position: absolute;
            bottom: 20px;
        }
    </style>
</head>
<body>
<div id="list"></div>
<div id="con">
    <main></main>
    <div id="bottom">
        <p style="font-size: 14px;color: #7a7a7a">1隐藏英文 2隐藏翻译 3测试  -/=键翻页</p>
        <input type="checkbox" id="test">测试
        <a href="/english">文档</a>
    </div>
</div>

<script>
    let test = false;
    let showEnglish = true;
    let showChinese = true;
    let words = [];
    let currentIndex = Number(localStorage.getItem("i")) || 0;
    let baseLinesCount = 0;

    const mainEl = document.querySelector("main");
    const listEl = document.getElementById("list");
    const testEl = document.getElementById("test");

    testEl.addEventListener("change", e => test = e.target.checked);

    const emptyP = () => Object.assign(document.createElement("p"), {textContent: ""});

    fetch("/CET4_T.json")
        .then(r => r.json())
        .then(data => {
            words = data;
            renderList();
            draw();
            focusLast();
        });

    function renderList() {
        listEl.innerHTML = words.map((w, i) => `
    <p data-i="${i}" class="${i === currentIndex ? "active" : ""}">
      ${i+1}:${showEnglish ? w.name : w.trans.join("；")}
    </p>
  `).join("");
    }

    listEl.addEventListener("click", e => {
        if (e.target.tagName !== "P") return;
        currentIndex = Number(e.target.dataset.i);
        draw();
        renderList();
        saveIndex();
    });

    document.addEventListener("keydown", e => {
        const key = e.key;
        if (key === "=") next();
        else if (key === "-") prev();
        else if (key === "Enter") handleEnter();
        else if (key === "Backspace") handleBackspace();
        else if (key === "1") toggleEnglish();
        else if (key === "2") toggleChinese();
        else if (key === "3") toggleTest();
        else if (key.length === 1) addChar(key);
        saveIndex();
    });

    function next() {
        currentIndex = Math.min(words.length - 1, currentIndex + 1);
        redraw();
    }

    function prev() {
        currentIndex = Math.max(0, currentIndex - 1);
        redraw();
    }

    function redraw() {
        draw();
        renderList();
    }

    function saveIndex() {
        localStorage.setItem("i", currentIndex);
    }

    function handleEnter() {
        const last = mainEl.lastElementChild;
        const input = last.textContent.trim();
        const correct = words[currentIndex].name.trim().toLowerCase();

        if (input) last.style.color = input.toLowerCase() === correct ? "green" : "red";

        if (test && input.toLowerCase() === correct) next();

        mainEl.appendChild(emptyP());
        focusLast();
    }

    function draw() {
        const w = words[currentIndex];
        mainEl.innerHTML = `
        <p>${showEnglish ? w.name : "--"}</p>
        ${showChinese ? w.trans.map(t => `<p>${t}</p>`).join("") : "<p>--</p>"}
      `;
        baseLinesCount = 1 + w.trans.length;
        mainEl.appendChild(emptyP());
        focusList();
    }

    function toggleEnglish() {
        showEnglish = !showEnglish;
        redraw();
    }

    function toggleChinese() {
        showChinese = !showChinese;
        draw();
    }

    function toggleTest(){
        testEl.checked=!testEl.checked;
        test=!test;
    }

    function addChar(k) {
        const p = mainEl.lastElementChild;
        p.textContent += k;
        focusLast();
    }

    function handleBackspace() {
        const items = mainEl.children;
        const last = items[items.length - 1];

        if (items.length <= baseLinesCount + 1) {
            last.textContent = last.textContent.slice(0, -1);
            return focusLast();
        }

        if (last.textContent) last.textContent = last.textContent.slice(0, -1);
        else {
            mainEl.removeChild(last);
            focusLast();
        }
    }

    function focusLast() {
        setCursorAt(mainEl.lastElementChild);
    }

    function setCursorAt(p) {
        const range = document.createRange();
        const sel = window.getSelection();
        range.selectNodeContents(p);
        range.collapse(false);
        sel.removeAllRanges();
        sel.addRange(range);
    }

    function focusList() {
        const a = listEl.querySelector("p.active");
        a?.scrollIntoView({behavior: "auto", block: "center"});
    }
</script>
</body>
</html>
