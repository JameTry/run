<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8"/>
    <style>
        #con {
            width: 500px;
            margin: 0 auto;
        }

        body {
            margin: 0;
            padding: 0;
            height: 100vh;
            display: flex;
            font-family: sans-serif;
        }

        #list {
            width: 200px;
            position: fixed;
            left: 20px;
            padding-right: 20px;
            height: 100vh;
            overflow-y: auto;
        }


        #list p.active {
            background: #247cfa;
            color: white;
            padding: 2px;
            font-size: 18px;
            font-weight: 600;
        }

        #bottom {
            position: fixed;
            bottom: 20px;
        }

        #static-info {
            border-bottom: 2px solid #eee;
            margin-bottom: 10px;
            padding-bottom: 10px;
        }

        .input-line {
            min-height: 1.5em;
            display: block;
            caret-color: transparent;
        }

        .input-line:last-child::after {
            content: '';
            display: inline-block;
            width: 2px;
            height: 1.2em;
            background-color: #007bff;
            vertical-align: text-bottom;
            margin-left: 2px;
            animation: blink 1s step-end infinite;
        }

        @keyframes blink {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0;
            }
        }
    </style>
</head>
<body>
<div id="list"></div>
<div id="con">
    <main></main>
    <div id="bottom">
        <p style="font-size: 14px;color: #7a7a7a">1隐藏英文 2隐藏翻译 3隐藏音标 4测试 -/=键翻页</p>
        <input type="checkbox" id="test">测试
        <a href="/english">文档</a>
    </div>
</div>
<script>
    let test = false;
    let showEnglish = true;
    let showChinese = true;
    let showPhonetic = true;
    let words = [];
    let currentIndex = Number(localStorage.getItem("i")) || 0;
    let speakT;
    const mainEl = document.querySelector("main");
    const listEl = document.getElementById("list");
    const testEl = document.getElementById("test");

    testEl.addEventListener("change", e => test = e.target.checked);

    class VoiceSynthesizer {
        constructor() {
            this.synthesis = window.speechSynthesis;
            this.voices = [];
            this.init();
        }

        init() {
            if (!this.isSupported()) {
                throw new Error('浏览器不支持语音合成');
            }
            this.loadVoices();
            this.synthesis.onvoiceschanged = () => this.loadVoices();
        }

        isSupported() {
            return 'speechSynthesis' in window;
        }

        loadVoices() {
            this.voices = this.synthesis.getVoices();
        }

        speak(text, options = {}) {
            const defaults = {
                lang: 'en-US',
                rate: 1,
                pitch: 1.0,
                volume: 1.0,
                voice: this.voices.find(v =>
                    v.lang.includes('en') && v.default
                ) || this.voices[0]
            };
            const utterance = new SpeechSynthesisUtterance(text);
            Object.assign(utterance, defaults, options);
            this.synthesis.cancel(); // 清空队列
            this.synthesis.speak(utterance);
            return utterance;
        }

        stop() {
            this.synthesis.cancel();
        }
    }

    const synthesizer = new VoiceSynthesizer();

    fetch("/CET4_T.json")
        .then(r => r.json())
        .then(data => {
            words = data;
            renderList();
            draw();
            focusList();
            focusLast();
        });

    function renderList() {
        listEl.innerHTML = words.map((w, i) => `
            <p data-i="${i}" class="${i === currentIndex ? "active" : ""}">
              ${i + 1}:${showEnglish ? w.name : w.trans.join("；")}
            </p>
        `).join("");
    }

    listEl.addEventListener("click", e => {
        if (e.target.tagName !== "P") return;
        currentIndex = Number(e.target.dataset.i);
        renderList();
        draw();
        focusList();
        saveIndex();
    });

    document.addEventListener("keydown", e => {
        const key = e.key;
        if (key === "=") next();
        else if (key === "-") prev();
        else if (key === "Enter") handleEnter();
        else if (key === "Backspace") handleBackspace();
        else if (key === "1") toggleEnglish();
        else if (key === "2") toggleChinese();
        else if (key === "3") togglePhonetic();
        else if (key === "4") toggleTest();
        else if (key === " ") speck();
        else if (key.length === 1) addChar(key);

        saveIndex();
    });

    function speck() {
        synthesizer.speak(words[currentIndex].name);
    }

    function next() {
        currentIndex = Math.min(words.length - 1, currentIndex + 1);
        renderList();
        draw();
        focusList();
    }

    function prev() {
        currentIndex = Math.max(0, currentIndex - 1);
        renderList();
        draw();
        focusList();
    }

    function redraw() {
        renderList();
        draw();
        focusList();
    }

    function saveIndex() {
        localStorage.setItem("i", currentIndex);
    }

    function handleEnter() {
        const last = mainEl.lastElementChild;
        const input = last.textContent.trim();
        const correct = words[currentIndex].name.trim().toLowerCase();

        if (input) last.style.color = input.toLowerCase() === correct ? "green" : "red";

        if (test && input.toLowerCase() === correct) {
            currentIndex = Math.min(words.length - 1, currentIndex + 1);
            renderList();
            draw();
            focusList();
            saveIndex();
            return;
        }

        mainEl.appendChild(emptyP());
        focusLast();
    }

    function draw() {
        const w = words[currentIndex];
        mainEl.innerHTML = `
          <div id="static-info">
              <p class="word">${showEnglish ? w.name : "--"}</p>
              ${showChinese ? w.trans.map(t => `<p class="trans">${t}</p>`).join("") : "<p class=\"trans\">--</p>"}
              <p class="phonetic">
                  ${showPhonetic ? `美&nbsp;${w.usphone}&nbsp;&nbsp;/&nbsp;&nbsp;英&nbsp;${w.ukphone}` : "--"}
              </p>
          </div>
        `;

        mainEl.appendChild(emptyP());
        clearTimeout(speakT);
        synthesizer.stop();
        synthesizer.speak(w.name);
        let i = 1;
        speakT = setInterval(() => {
            i++;
            synthesizer.speak(w.name)
            if (i > 2) {
                clearTimeout(speakT);
            }
        }, 2000);

        setTimeout(focusLast, 0);
    }

    function emptyP() {
        const p = document.createElement("p");
        p.className = "input-line";
        return p;
    }

    function toggleEnglish() {
        showEnglish = !showEnglish;
        renderList();
        draw();
        focusList();
    }

    function toggleChinese() {
        showChinese = !showChinese;
        draw();
    }
    function togglePhonetic() {
        showPhonetic = !showPhonetic;
        draw();
        focusList();
    }

    function toggleTest() {
        testEl.checked = !testEl.checked;
        test = !test;
    }

    function addChar(k) {
        let last = mainEl.lastElementChild;

        if (!last || !last.classList.contains("input-line")) {
            last = emptyP();
            mainEl.appendChild(last);
        }

        last.textContent += k;
        focusLast();
    }

    function handleBackspace() {
        const last = mainEl.lastElementChild;

        if (!last || !last.classList.contains("input-line")) {
            return;
        }

        if (last.textContent) {
            last.textContent = last.textContent.slice(0, -1);
        } else {
            return;
        }

        focusLast();
    }

    function focusLast() {
        setCursorAt(mainEl.lastElementChild);
    }

    function setCursorAt(p) {
        const range = document.createRange();
        const sel = window.getSelection();
        range.selectNodeContents(p);
        range.collapse(false);
        sel.removeAllRanges();
        sel.addRange(range);
    }

    function focusList() {
        const a = listEl.querySelector("p.active");
        if (!a) return;

        const targetOffset = a.offsetTop;
        const targetHeight = a.offsetHeight;
        const containerHeight = listEl.clientHeight;
        listEl.scrollTop = Math.max(0, targetOffset - (containerHeight / 2) + (targetHeight / 2));
    }
</script>

</body>
</html>
